{"componentChunkName":"component---src-pages-markdown-remark-frontmatter-slug-js","path":"/articles/donut-hole-skipping-in-jetpack-compose/","result":{"data":{"markdownRemark":{"html":"<p class=\"para\">I recently stumbled on a term that was brought up in a few conversations related to Jetpack Compose. It's being referred to as ‚Äúdonut-hole skipping‚Äù . The name certainly intrigued me enough to go down the rabbit hole, or in this case, the donut hole üç© Given how early we are in the Jetpack Compose journey, I think it would be valuable to cover some basic concepts to get everyone at the same baseline before we dough (üòâ) into the more interesting bits.</p>\n<h1 class=\"heading\">Recomposition</h1>\n<blockquote>\n<p class=\"para\">Recomposition is the process of calling your composable functions again when its inputs change</p>\n</blockquote>\n<p class=\"para\">At a high level, anytime the inputs or the state of a <code class=\"language-text\">@Composable</code> function changes, it would be valuable for the function to be invoked again so that the latest changes are reflected. This behavior is critical to how Jetpack Compose works and is also what makes it so powerful as this reactive nature is a first class citizen of the framework. If I were to oversimplify this, anyone familiar with the classic Android View system might remember a method called <code class=\"language-text\">invalidate()</code> that was used to ensure that the latest state of the <code class=\"language-text\">View</code> was represented on the screen.</p>\n<p class=\"para\">This is effectively what recomposition is responsible for as well with an important nuance - it's much smarter than the previous UI toolkit as it will avoid redundant work when possible using smart optimizations. With that said, let's look at some examples of recomposition in action and hopefully it will lead us to this hunger inducing optimization that I spoke about at the start of this post.</p>\n<h2 class=\"subheading\">Example 1</h2>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Composable</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">MyComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> counter <span class=\"token keyword\">by</span> remember <span class=\"token punctuation\">{</span> <span class=\"token function\">mutableStateOf</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">CustomText</span><span class=\"token punctuation\">(</span>\n        text <span class=\"token operator\">=</span> <span class=\"token string\">\"Counter: <span class=\"token interpolation variable\">$counter</span>\"</span><span class=\"token punctuation\">,</span>\n        modifier <span class=\"token operator\">=</span> Modifier\n            <span class=\"token punctuation\">.</span><span class=\"token function\">clickable</span> <span class=\"token punctuation\">{</span>\n                counter<span class=\"token operator\">++</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation builtin\">@Composable</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">CustomText</span><span class=\"token punctuation\">(</span>\n    text<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    modifier<span class=\"token operator\">:</span> Modifier<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">Text</span><span class=\"token punctuation\">(</span>\n        text <span class=\"token operator\">=</span> text<span class=\"token punctuation\">,</span>\n        modifier <span class=\"token operator\">=</span> modifier<span class=\"token punctuation\">.</span><span class=\"token function\">padding</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">.</span>dp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        style <span class=\"token operator\">=</span> <span class=\"token function\">TextStyle</span><span class=\"token punctuation\">(</span>\n            fontSize <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">.</span>sp<span class=\"token punctuation\">,</span>\n            textDecoration <span class=\"token operator\">=</span> TextDecoration<span class=\"token punctuation\">.</span>Underline<span class=\"token punctuation\">,</span>\n            fontFamily <span class=\"token operator\">=</span> FontFamily<span class=\"token punctuation\">.</span>Monospace\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p class=\"para\">We created a simple composable function called <code class=\"language-text\">MyComponent</code> that initializes a state object to hold the value of <code class=\"language-text\">counter</code>. This value is rendered by the <code class=\"language-text\">Text</code> composable and every time you tap on this text, counter is incremented. What we are interested to see is which parts of this function are reinvoked. In order to investigate this further, we are going to use log statements. But we want to trigger these log statements only when recompositions are happening. This sounds like the perfect use case for <a href=\"https://developer.android.com/jetpack/compose/side-effects#sideeffect-publish\" class=\"url\">SideEffect</a>, a composable function that is reinvoked on every successful recomposition. Since we need to use this in a few places, let's write a helper function that will be useful for this investigation across all the examples. I'd like to credit my friend <a href=\"https://twitter.com/objcode\" class=\"url\">Sean McQuillan</a> for the code snippet below üôè</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> value<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Note the inline function below which ensures that this function is essentially</span>\n<span class=\"token comment\">// copied at the call site to ensure that its logging only recompositions from the</span>\n<span class=\"token comment\">// original call site.</span>\n<span class=\"token annotation builtin\">@Composable</span>\n<span class=\"token keyword\">inline</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">LogCompositions</span><span class=\"token punctuation\">(</span>tag<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>BuildConfig<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> ref <span class=\"token operator\">=</span> remember <span class=\"token punctuation\">{</span> <span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        SideEffect <span class=\"token punctuation\">{</span> ref<span class=\"token punctuation\">.</span>value<span class=\"token operator\">++</span> <span class=\"token punctuation\">}</span>\n        Log<span class=\"token punctuation\">.</span><span class=\"token function\">d</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Compositions: <span class=\"token interpolation variable\">$msg</span> <span class=\"token interpolation\"><span class=\"token delimiter variable\">${</span>ref<span class=\"token punctuation\">.</span>value<span class=\"token delimiter variable\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p class=\"para\">Let's make use of this helper function in our example and give it a spin!</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">@Composable\nfun MyComponent() {\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   val counter by remember { mutableStateOf(0) }\n</span>\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>   LogCompositions(\"JetpackCompose.app\", \"MyComposable function\")\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   CustomText(\n<span class=\"token prefix unchanged\"> </span>       text = \"Counter: $counter\",\n<span class=\"token prefix unchanged\"> </span>       modifier = Modifier\n<span class=\"token prefix unchanged\"> </span>           .clickable {\n<span class=\"token prefix unchanged\"> </span>               counter++\n<span class=\"token prefix unchanged\"> </span>           },\n<span class=\"token prefix unchanged\"> </span>   )\n</span>}\n\n@Composable\nfun CustomText(\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   text: String,\n<span class=\"token prefix unchanged\"> </span>   modifier: Modifier = Modifier,\n</span>) {\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>   LogCompositions(\"JetpackCompose.app\", \"CustomText function\")\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   Text(\n<span class=\"token prefix unchanged\"> </span>       text = text,\n<span class=\"token prefix unchanged\"> </span>       modifier = modifier.padding(32.dp),\n<span class=\"token prefix unchanged\"> </span>       style = TextStyle(\n<span class=\"token prefix unchanged\"> </span>           fontSize = 20.sp,\n<span class=\"token prefix unchanged\"> </span>           textDecoration = TextDecoration.Underline,\n<span class=\"token prefix unchanged\"> </span>           fontFamily = FontFamily.Monospace\n<span class=\"token prefix unchanged\"> </span>       )\n<span class=\"token prefix unchanged\"> </span>   )\n</span>}</code></pre></div>\n<p class=\"para\">On running this example, we notice that both <code class=\"language-text\">MyComponent</code> &#x26; <code class=\"language-text\">CustomText</code> are recomposed every time the value of the counter changes. We'll keep this in mind and look at another example so that we can compare the behavior and hopefully derive some insights ü§ûüèª</p>\n<p class=\"para\"><img src=\"/articles/donut-hole-skipping/donut-hole-skipping-example-1.gif\" alt=\"Example 1\" class=\"img\">\n<em>TODO: Example 1</em></p>\n<h2 class=\"subheading\">Example 2</h2>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">@Composable\nfun MyComponent() {\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   val counter by remember { mutableStateOf(0) }\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   LogCompositions(\"JetpackCompose.app\", \"MyComposable function\")\n</span>\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>   Button(onClick = { counter++ }) {\n<span class=\"token prefix inserted\">+</span>       LogCompositions(\"JetpackCompose.app\", \"Button\")\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>       CustomText(\n<span class=\"token prefix unchanged\"> </span>           text = \"Counter: $counter\",\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>            modifier = Modifier\n<span class=\"token prefix deleted\">-</span>                .clickable {\n<span class=\"token prefix deleted\">-</span>                    counter++\n<span class=\"token prefix deleted\">-</span>                },\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>       )\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>   }\n</span>}</code></pre></div>\n<p class=\"para\">We are reusing our previous example with a small difference - we introduce a <code class=\"language-text\">Button</code> composable to handle our click logic and moved the <code class=\"language-text\">CustomText</code> function inside the scope of the <code class=\"language-text\">Button</code> function. We also added a log statement inside the scope of the Button function to check if that lambda is being executed. Let's run this example and monitor the log statements.</p>\n<p class=\"para\"><img src=\"/articles/donut-hole-skipping/donut-hole-skipping-example-2.gif\" alt=\"Example 2\" class=\"img\">\n<em>TODO: Example 2</em></p>\n<p class=\"para\">Here's where things start to get really interesting. We see that the body of <code class=\"language-text\">MyComponent</code> was executed during the very first composition along with the body of the <code class=\"language-text\">Button</code> composable and the<code class=\"language-text\">CustomText</code> composable. However, every subsequent recomposition only causes the <code class=\"language-text\">Button</code> and the <code class=\"language-text\">CustomText</code> composable to be invoked again while the body of <code class=\"language-text\">MyComponent</code> is skipped altogether. Interesting..... ü§î</p>\n<h1 class=\"heading\">Recomposition Scope</h1>\n<p class=\"para\">In order to understand how Compose is able to optimize recompositions, it is important to take into account the scopes of the functions that we are using in our examples. Compose keeps track of these scopes under-the-hood and divides a Composable function into these smaller units for more efficient recompositions. In order to wrap our heads around what this means, let's look at both our examples again and understand the scopes that are available for the Compose runtime to do its book-keeping.</p>\n<p class=\"para\"><img src=\"/articles/donut-hole-skipping/example1-scope.png\" alt=\"Example 1\" class=\"img\">\n<em>TODO</em></p>\n<p class=\"para\">We see that there's a couple lambda scopes at play in the first example i.e the scope of the <code class=\"language-text\">MyComponent</code> function and the scope of <code class=\"language-text\">CustomText</code> function. Furthermore, <code class=\"language-text\">CustomText</code> is in the lambda scope of the <code class=\"language-text\">MyComponent</code> function. When the value of the the counter changes, we previously noticed that both these scopes were being reinvoked and here's why -</p>\n<ul>\n<li class=\"listElement\"><code class=\"language-text\">CustomText</code> is recomposed because its text parameter changed as it includes the counter value. This makes sense and is probably what you want anyway.</li>\n<li class=\"listElement\"><code class=\"language-text\">MyComponent</code> is recomposed because its lambda scope captures the counter state object and a smaller lambda scope wasn't available for any recomposition optimizations to kick in.</li>\n</ul>\n<p class=\"para\">Now you might wonder what I mean when I say \"a smaller lambda scope wasn't available\" and the next example will make this clear.</p>\n<p class=\"para\"><img src=\"/articles/donut-hole-skipping/example2-scope.png\" alt=\"Example 2\" class=\"img\">\n<em>TODO</em></p>\n<p class=\"para\">In this example, we previously noticed that only <code class=\"language-text\">Button</code> and <code class=\"language-text\">CustomText</code> composables were invoked when the value of counter updated and <code class=\"language-text\">MyComponent</code> was skipped altogether.</p>","frontmatter":{"slug":"/articles/donut-hole-skipping-in-jetpack-compose","date":"September 04, 2021","title":"What is ‚Äúdonut-hole skipping‚Äù in Jetpack Compose?","description":"üç© Learn how Jetpack Compose is able to be smart during recomposition!","authorName":"Vinay Gaba","authorImageUrl":"https://jetpackcompose.app/vinay_gaba_profile_picture.jpeg","authorProfileUrl":"https://twitter.com/vinaygaba","heroImageUrl":"/articles/donut-hole-skipping/donut-hole-skipping-hero.png"}}},"pageContext":{"id":"f5d76e76-275a-5d16-9a0b-738ed94bb244","frontmatter__slug":"/articles/donut-hole-skipping-in-jetpack-compose","__params":{"frontmatter__slug":"articles"}}},"staticQueryHashes":[]}